# NF_HEDM/ — Near-Field High-Energy Diffraction Microscopy

This directory contains the NF-HEDM reconstruction pipeline: C source code for voxel-by-voxel forward-model reconstruction, Python workflow drivers, and pre-computed orientation seed files.

---

## Directory Structure

```
NF_HEDM/
├── src/               # C source code (35 files)
├── workflows/         # Python workflow drivers
├── bin/               # Compiled binaries (generated by build)
├── seedOrientations/  # Pre-computed seed orientation files (downloaded by build.sh)
├── CMakeLists.txt     # Build configuration
└── *.txt              # Legacy seed files (cubic, hex, tetragonal)
```

---

## How NF-HEDM Works

NF-HEDM reconstructs 3D spatially resolved orientation maps by placing the detector close to the sample (5–10 mm). At this distance, diffraction spots from individual grains are spatially separated. The reconstruction algorithm:

1. **Seeds** candidate orientations from a prior FF-HEDM analysis.
2. **Simulates** expected diffraction patterns for each voxel/orientation pair.
3. **Compares** simulated vs. measured spot patterns.
4. **Assigns** the best-matching orientation to each voxel.

The output is a `.mic` file containing position, orientation, and confidence for every voxel in the reconstruction grid.

---

## Workflow Drivers (`workflows/`)

| File | Description |
|------|-------------|
| `nf_MIDAS.py` | **Main NF-HEDM workflow.** Orchestrates image processing, grid generation, forward simulation, and reconstruction. Supports multiple compute backends. See [NF_Analysis manual](../manuals/NF_Analysis.md). |
| `nf_MIDAS_Multiple_Resolutions.py` | **Multi-resolution NF-HEDM.** Iterative reconstruction at increasing grid resolution for large volumes. See [NF_MultiResolution_Analysis manual](../manuals/NF_MultiResolution_Analysis.md). |
| `localConfig.py` | Parsl execution configuration for local runs. |
| `orthrosAllConfig.py` | Parsl configuration for Orthros cluster. |
| `polarisConfig.py` | Parsl configuration for ALCF Polaris. |
| `marquetteConfig.py`, `purdueConfig.py`, `uMichConfig.py`, `adhocConfig.py` | Other cluster configurations. |

---

## Source Code (`src/`)

### Image Processing

| Source | Description |
|--------|-------------|
| `ImageProcessingLibTiffOMP.c` | **Primary image processor.** Dark subtraction, background removal, and edge detection (LoG filter with 8-connectivity) for TIFF detector images. OpenMP parallelized. |
| `ImageProcessingLibTiff.c` | Single-threaded image processor for TIFF data. |
| `ImageProcessingHDF.c` | Image processor for HDF5 detector data. |
| `MedianImageLibTiff.c` / `MedianImageHDF.c` | Compute median dark frames from TIFF or HDF5 data. |

### Reconstruction

| Source | Description |
|--------|-------------|
| `FitOrientationOMP.c` | **Primary reconstruction engine.** Voxel-by-voxel forward-model fitting with OpenMP parallelism. |
| `FitOrientation.c` | Single-threaded reconstruction engine. |
| `FitOrientationParameters.c` | Detector geometry parameter optimization for NF-HEDM. |
| `FitOrientationParametersMultiPoint.c` | Multi-point parameter optimization using selected high-confidence voxels. |
| `FitOrientationSinglePoint.c` | Single-point parameter optimization for iterative calibration. |
| `SharedFuncsFit.c` | Shared functions used by all fitting routines. |

### Grid & Seed Generation

| Source | Description |
|--------|-------------|
| `MakeHexGrid.c` | Generate hexagonal reconstruction grids. |
| `GenSeedOrientationsFF2NFHEDM.c` | Convert FF-HEDM grain orientations to NF-HEDM seed format. |
| `MakeDiffrSpots.c` | Generate simulated diffraction spot positions for seeds. |
| `CalcDiffractionSpots.c` | Calculate expected spot positions for a given orientation. |
| `MMapImageInfo.c` | Memory-mapped image data reader for efficient voxel lookups. |

### Post-Processing

| Source | Description |
|--------|-------------|
| `ParseMic.c` | Parse and manipulate `.mic` reconstruction files. |
| `Mic2GrainsList.c` | Convert `.mic` voxel data to a grain list with spatial neighbor merging. |
| `NFGrainsCalc.c` | Calculate grain-level statistics from voxel-by-voxel reconstructions. |
| `compareNF.c` | Compare two NF reconstructions (e.g., before/after optimization). |
| `ProcessNFMicRemote.c` | Remote processing of `.mic` files for distributed workflows. |
| `filterGridfromTomo.c` | Filter NF grid points using tomography data (mask air/void regions). |

### Simulation & Validation

| Source | Description |
|--------|-------------|
| `simulateNF.c` | **Forward simulation.** Simulate NF-HEDM diffraction patterns from known orientations for validation. |
| `SimulateDiffractionSpots.c` | Detailed diffraction spot simulation. |
| `ParseDeconvOutput.c` | Parse deconvolution output for Richardson-Lucy deconvolution. |
| `RLDeconv.py` | Richardson-Lucy deconvolution for improving NF image sharpness. |

### SGInfo Library

| Source | Description |
|--------|-------------|
| `sgclib.c`, `sgfind.c`, `sghkl.c`, `sginfo.h`, `sgio.c`, `sgsi.c` | Space group information library (shared with FF_HEDM). |

---

## Seed Orientations

The `seedOrientations/` directory contains pre-computed orientation seed files for common crystal symmetries. These are downloaded automatically by `build.sh`. For custom crystal systems, generate seeds using `GenSeedOrientationsFF2NFHEDM` with your FF-HEDM results.

---

## See Also

- [NF_Analysis manual](../manuals/NF_Analysis.md) — complete user guide
- [NF_calibration manual](../manuals/NF_calibration.md) — detector calibration
- [NF_MultiResolution_Analysis manual](../manuals/NF_MultiResolution_Analysis.md) — multi-resolution workflow
- [NF_gui manual](../manuals/NF_gui.md) — interactive GUI
