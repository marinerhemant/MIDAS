# FF_HEDM/ — Far-Field High-Energy Diffraction Microscopy

This directory contains the complete FF-HEDM analysis pipeline: C source code for high-performance peak search, indexing, fitting, and grain processing, plus Python workflow drivers that orchestrate the full analysis.

---

## Directory Structure

```
FF_HEDM/
├── src/           # C source code (88 files)
├── workflows/     # Python workflow drivers
├── bin/           # Compiled binaries (generated by build)
├── Example/       # Test dataset (Au, single layer)
└── CMakeLists.txt # Build configuration
```

---

## Workflow Drivers (`workflows/`)

| File | Description |
|------|-------------|
| `ff_MIDAS.py` | **Main FF-HEDM workflow.** Orchestrates the full pipeline: data conversion → peak search → merging → indexing → fitting → grain processing → consolidated HDF5. Supports `-reprocess` mode. See [FF_Analysis manual](../manuals/FF_Analysis.md). |
| `pf_MIDAS.py` | **Point-Focus HEDM workflow.** Similar pipeline for focused-beam geometry with spatial scanning. See [PF_Analysis manual](../manuals/PF_Analysis.md). |
| `ff_dual_datasets.py` | **Dual-dataset analysis.** Combines two FF-HEDM datasets for improved grain finding. See [FF_dual_datasets manual](../manuals/FF_Dual_Datasets.md). |
| `localConfig.py` | Parsl execution configuration for local runs. |
| `orthrosAllConfig.py` | Parsl configuration for Orthros cluster. |
| `polarisConfig.py` | Parsl configuration for ALCF Polaris supercomputer. |
| `marquetteConfig.py` | Parsl configuration for Marquette cluster. |
| `purdueConfig.py` | Parsl configuration for Purdue cluster. |
| `uMichConfig.py` | Parsl configuration for University of Michigan cluster. |
| `adhocConfig.py` | Template for custom cluster configurations. |

---

## Source Code (`src/`)

### Pipeline Stages

The FF-HEDM pipeline proceeds through these stages, each implemented as one or more C binaries:

```
Raw Data → GetHKLList → PeaksFitting → MergeOverlappingPeaks → CalcRadius
     → FitSetupParams → Indexer → FitPosOrStrains → ProcessGrains → MatchGrains
```

### Data Preparation

| Source | Description |
|--------|-------------|
| `GetHKLList.c` / `GetHKLListZarr.c` | Generate list of expected HKL reflections for the crystal system. Uses SGInfo subroutines. |
| `GenMedianDark.c` | Compute median dark frame from a set of dark images. |
| `FileReader.c` / `.h` | Detector file reader supporting GE, TIFF, and HDF5 formats. |

### Peak Search & Fitting

| Source | Description |
|--------|-------------|
| `PeaksFittingOMPZarrRefactor.c` | **Primary peak fitter.** Two-stage decomposed pseudo-Voigt fitting (Lorentzian + Gaussian) with OpenMP parallelism. Reads Zarr-ZIP data. |
| `PeaksFittingOMPZarr.c` | Earlier Zarr-based peak fitter. |
| `PeaksFittingOMP.c` | OpenMP peak fitter for legacy file formats. |
| `PeaksFittingPerFile.c` | Per-file peak fitting for non-Zarr data. |

### Peak Merging

| Source | Description |
|--------|-------------|
| `MergeOverlappingPeaksAllZarr.c` | **Primary merger.** Merges peaks from overlapping rotation frames, generates `MergeMap.csv` provenance. |
| `MergeOverlappingPeaks.c` / `MergeOverlappingPeaksAll.c` | Legacy merging implementations. |
| `CalcRadius.c` / `CalcRadiusAll.c` / `CalcRadiusAllZarr.c` | Compute grain radii and volume estimates from merged peak data. |

### Indexing

| Source | Description |
|--------|-------------|
| `IndexerOMP.c` | **Primary indexer.** OpenMP-parallelized grain indexing from merged spots. |
| `IndexerLinuxArgsOptimizedShm.c` | Shared-memory optimized indexer for multi-node execution. |
| `IndexerScanningOMP.c` | Indexer for scanning/point-focus HEDM geometry. |
| `IndexerScanningCUDA.cu` | GPU-accelerated scanning indexer (CUDA). |

### Strain Fitting

| Source | Description |
|--------|-------------|
| `FitPosOrStrainsOMP.c` | **Primary strain fitter.** Refines grain position, orientation, and full elastic strain tensor with OpenMP. |
| `FitPosOrStrains.c` | Single-threaded strain fitter. |
| `FitPosOrStrainsDoubleDataset.c` | Strain fitting using two combined datasets. |
| `FitOrStrainsScanningOMP.c` | Strain fitting for scanning HEDM geometry. |
| `FitSetupParamsAll.c` / `FitSetupParamsAllZarr.c` | Set up fitting parameters from indexed spots. |

### Grain Processing & Matching

| Source | Description |
|--------|-------------|
| `ProcessGrains.c` / `ProcessGrainsZarr.c` | Process indexed grains: compute final orientations, positions, strains.  |
| `MatchGrains.c` | Match grains across load states or layers. Bug-fixed in v9 (was using `abs()` on doubles). |
| `GrainTracking.c` | Track grain evolution across multiple load states. |
| `GetMisorientation.c` | Quaternion-based crystallographic misorientation calculations. |

### Calibration

| Source | Description |
|--------|-------------|
| `CalibrantPanelShiftsOMP.c` | **Primary calibrant.** Fit detector geometry (tilt, distance, beam center) from powder calibrant rings, with panel shift support. |
| `FitTiltBCLsdSampleOmegaCorrection.c` | Fit tilt, beam center, Lsd, and omega correction. |
| `FitTiltX.c` | Fit detector tilt about X axis (requires Friedel pairs). |
| `FitWedge.c` / `FitWedgeParallel.c` | Fit wedge angle (rotation axis tilt). |

### Simulation & Validation

| Source | Description |
|--------|-------------|
| `ForwardSimulation.c` | Forward diffraction simulation from grain parameters. |
| `ForwardSimulationCompressed.c` | Compressed-output forward simulation with OpenMP. |
| `CalcDiffractionSpots.c` | Calculate expected diffraction spot positions from grain orientations. |
| `CalcPeakProfile.c` | Simulate peak profiles for validation. |
| `SimulateScanning.c` | Simulate scanning HEDM diffraction data. |

### Integration & Detector Mapping

| Source | Description |
|--------|-------------|
| `IntegratorZarr.c` / `IntegratorZarrOMP.c` | Radial integration (caking) engine for Zarr data. |
| `Integrator.c` / `Integrator.cu` | Radial integration (CPU and GPU versions). |
| `DetectorMapper.c` / `DetectorMapperZarr.c` | Map raw detector pixels to (R, η) coordinates. |
| `DetectorMapperGPUCSR.cu` | GPU-accelerated detector mapping using compressed sparse row format. |

### SGInfo Library

| Source | Description |
|--------|-------------|
| `sgclib.c`, `sgfind.c`, `sghkl.c`, `sginfo.h`, `sgio.c`, `sgsi.c` | Space group information library for HKL list generation (third-party, from CCI/LBL). |

---

## Example Dataset

The `Example/` directory contains a small Au dataset (1 layer) for testing:

```bash
cd Example
python ../utils/test_ff_hedm.py -nCPUs 8
```

---

## See Also

- [FF_Analysis manual](../manuals/FF_Analysis.md) — complete user guide
- [FF_calibration manual](../manuals/FF_Calibration.md) — calibration workflow
- [FF_Match_Stack_Reconstructions manual](../manuals/FF_Match_Stack_Reconstructions.md) — grain matching
