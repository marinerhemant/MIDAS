# User Manual: `ForwardSimulationCompressed`

**Version:** 7.0  
**Contact:** hsharma@anl.gov

---

## 1. Program Overview

`ForwardSimulationCompressed` is a high-performance command-line tool for simulating far-field High Energy Diffraction Microscopy (FF-HEDM) experiments. It takes a description of a crystalline sample (grain orientations, positions, and strains) and experimental geometry as input, and produces simulated detector images as output.

The simulation is highly parallelized for speed and includes advanced features to accurately model physical effects such as:
*   Detector distortions and tilts.
*   Wavelength/energy spread (`Δλ/λ`).
*   Strain within crystal lattices.
*   Relative peak intensities from powder diffraction data.
*   Sub-pixel spot positioning for high-fidelity images.

The output is a set of compressed image files in a Zarr/ZIP format, suitable for analysis or direct comparison with experimental data.

## 2. How to Run the Program

The program is executed from the command line with two arguments: a parameter file and the number of CPU cores to use.

#### Command Syntax:
```bash
./ForwardSimulationCompressed <ParameterFile> <nCPUs>
```

#### Arguments:
*   `<ParameterFile>`: The path to a text file containing all simulation parameters. Details are in Section 3.
*   `<nCPUs>`: The number of CPU cores (threads) to use for the simulation. For best performance, this should be set to the number of physical cores on your machine.

#### Example:
```bash
./ForwardSimulationCompressed experiment_params.txt 16
```
This command runs the simulation using the settings in `experiment_params.txt` and parallelizes the computation across 16 CPU cores.

## 3. The Parameter File

The parameter file is a plain text file that controls every aspect of the simulation. Each line consists of a keyword followed by one or more values, separated by spaces. Lines starting with `%` or `#` can be used for comments.

### 3.1. Required Files and Their Formats

Before running, you must have several files in your working directory.

**A. `hkls.csv` (Required)**
This file lists the crystallographic planes (HKLs) to be simulated for your material's crystal structure. It is generated by the `GetHKLList` utility (which is run automatically by the program). The format is a space-separated text file with a one-line header.

*   **Format:**
    ```
    h k l Intensity D-spacing RingNr
    1 1 1 1.00 2.1105 1
    2 0 0 0.49 1.8277 2
    ...
    ```
*   The simulation uses the `h`, `k`, `l`, and `RingNr` columns.

**B. `positions.csv` (Optional, for Multi-Scan)**
If you are simulating a multi-scan experiment (controlled by the `nScans` parameter), this file must be present. It specifies the sample translation offset for each scan.

*   **Format:** A single column of numbers, with one value per scan. The units should match the units of the grain positions in your input file (typically microns).
    ```
    0.0
    50.0
    100.0
    ...
    ```

**C. Input Grain Data File (Required)**
This file contains the core information about your sample's microstructure. The program is flexible and can read several formats, specified with the `InFileName` parameter.

*   **Supported Formats:**
    *   **Grains.csv:** A standard format from reconstruction software.
    *   **EBSD File:** A text file with columns for `X Y Z Eul1 Eul2 Eul3`. The Euler angles should be in degrees.
    *   **VTK File:** A `.vtk` file from a finite element simulation (e.g., ABAQUS). The code is designed to parse specific fields for position, orientation, and strain.
    *   **Binary Format (`.bin`):** A custom, high-speed binary format containing the orientation and strain data.

### 3.2. Parameter Keywords

Below is a complete list of keywords that can be used in the parameter file.

**File I/O:**
*   `InFileName <filename>`: Path to the input file containing grain data.
*   `OutFileName <prefix>`: The base name for the output ZIP files. The final output will be `<prefix>_scanNr_X.zip`.
*   `IntensitiesFile <filename>` (Optional): Path to a file containing relative peak intensities. If not provided, all peaks will have equal intensity. The format must match `mpxrd_hkls.txt` (header + 6 columns: h k l SpotInt D-spacing RingNr).

**Experimental Geometry:**
*   `Lsd <value>`: Sample-to-detector distance (in microns).
*   `Wavelength <value>`: Wavelength of the X-ray beam (in Angstroms).
*   `OmegaStart <value>`: Starting omega angle for the simulation (in degrees).
*   `OmegaEnd <value>`: Ending omega angle for the simulation (in degrees).
*   `OmegaStep <value>`: The omega step size per frame (in degrees).

**Detector Parameters:**
*   `NrPixels <value>`: The number of pixels along one edge of the square detector (e.g., `2048`).
*   `px <value>`: The physical size of a single pixel (in microns).
*   `BC <y_center> <z_center>`: The pixel coordinates of the beam center on the detector.

**Detector Distortion Correction (Optional):**
These parameters model the geometric distortions of a real detector.
*   `tx <value>`, `ty <value>`, `tz <value>`: Detector tilt angles (in degrees).
*   `RhoD <value>`, `p0 <value>`, `p1 <value>`, `p2 <value>`: Coefficients for the radial distortion model.

**Material and Simulation Parameters:**
*   `LatticeConstant <a> <b> <c> <alpha> <beta> <gamma>`: The lattice parameters of the crystal structure. For cubic, all lengths are equal and angles are 90.
*   `PeakIntensity <value>`: The maximum intensity value for a single diffraction spot before normalization.
*   `GaussWidth <value>`: The standard deviation of the Gaussian used to blur the spots, in units of pixels. Controls the spot size.
*   `EResolution <spread> <num_samples>` (Optional): Simulates the wavelength spread.
    *   `<spread>`: The fractional spread `Δλ/λ` (e.g., `0.001` for 0.1%).
    *   `<num_samples>`: The number of discrete wavelengths to sample across the spread (an odd integer like 5 or 7 is recommended).
*   `nScans <value>`: The number of scans to simulate. If greater than 1, a `positions.csv` file is required.

**Output Control:**
*   `WriteSpots <0_or_1>`: If set to `1`, a `SpotMatrixGen.csv` file will be generated, logging the detailed information for every simulated diffraction spot. `0` disables this.

### 3.3. Example Parameter File
```
# ==================================
# Example Parameters for Ti-7Al
# ==================================

# --- File Paths ---
InFileName        meso_grain_file.vtk
OutFileName       Ti7Al_simulation_results
IntensitiesFile   ti_alpha_intensities.txt

# --- Experimental Geometry ---
Lsd               800000.0   # 800 mm in microns
Wavelength        0.1653     # Angstroms
OmegaStart        0.0
OmegaEnd          180.0
OmegaStep         0.5

# --- Detector ---
NrPixels          2048
px                200.0      # 200 micron pixels
BC                1024.5 1023.0

# --- Distortion (example values) ---
tx                -0.12
ty                0.05
tz                0.01
RhoD              180000.0
p0                -0.0001
p1                0.00005
p2                0.0002

# --- Material & Simulation ---
LatticeConstant   2.95 2.95 4.68 90 90 120 # Hexagonal Ti-alpha
PeakIntensity     2000.0
GaussWidth        1.5
EResolution       0.001 5 # 0.1% spread, sampled with 5 points

# --- Multi-Scan ---
nScans            1

# --- Output Control ---
WriteSpots        1
```

### 4. Output Format

The primary output of the simulation is one or more ZIP files, one for each scan. These ZIP files are structured in the **Zarr format**, a modern standard for chunked, compressed n-dimensional arrays. This format is highly efficient and easily read by many scientific data analysis packages, especially in Python.

*   **File Naming:** `OutFileName_scanNr_X.zip` (e.g., `Ti7Al_simulation_results_scanNr_0.zip`)
*   **Internal Structure:** Inside the ZIP file, the data is organized as `exchange/data/`. The detector images are stored as individual, compressed files, one for each omega step (e.g., `0.0.0`, `1.0.0`, etc.).
*   **Data Type:** The image data is stored as 16-bit unsigned integers (`uint16`), normalized so that the brightest pixel in the entire scan corresponds to an intensity of `15000`.

To read this data, you can use Python libraries such as `zarr`.

---

## See Also

- [FF_Analysis.md](FF_Analysis.md) — Standard FF-HEDM analysis (produces Grains.csv used as input here)
- [FF_Interactive_Plotting.md](FF_Interactive_Plotting.md) — Visualizing FF-HEDM results and simulated data
- [FF_autocalibrate.md](FF_autocalibrate.md) — Geometry calibration from calibrant rings

---